<!DOCTYPE html>
<html>
<head>
<title>Game</title>
<link href="lib/dojo/resources/dojo.css" rel="stylesheet">
<link href="lib/dijit/themes/tundra/tundra.css" rel="stylesheet">
<link href="lib/dojox/grid/resources/tundraGrid.css" rel="stylesheet">
<link href="themes/game.css" rel="stylesheet">
<!-- switch the commented lines below if using local dojo libraries -->
<!-- <script data-dojo-config="async:true" src="lib/dojo/dojo.js"></script> -->
<script src="http://ajax.googleapis.com/ajax/libs/dojo/1.7.2/dojo/dojo.js"></script>
<script>
var dc; // variable needed to setting timeout on card flip toggle
var front;
var back;
var timer;
var hoverok;
var cardWidth, cardHeight, sizePercent;
var headerHeight, playerHeight, footerHeight;
var cardMinHeight, cardMinWidth, footerMinHeight;
var maxX, maxY;
var tmpFront, tmpCard, tmpMnode; /* TODO delete */
var initCardWidth, initCardHeight;
require([
  "dojo/dom-construct",
  "dojo/dom-class",
  "dojo/dnd/Moveable",
  "dojo/query"
  ], function(domConstruct,domClass){
  //findWindowVars();
  maxX = (window.innerWidth/2);maxY = (window.innerHeight/2);
  setCardVars();
  setAreaVars();
  function createCard(id,image){
    /* TODO use data-dojo-props for variables that are HTML-invalid */
    var card = domConstruct.create("div",{
      id:id,
      //style:"height:"+cardHeight+"px;width:"+cardWidth+"px;min-height:"+cardMinHeight+"px;min-width:"+cardMinWidth+"px;",
      style:"height:"+cardHeight+"px;width:"+cardWidth+"px;",
      xPercent: null, /* how far current x is from the center */
      yPercent: null, /* how far current y is from the center */
      sizePercent: sizePercent, /* card scaling. based on Y since most screen sizes are limited more by the y-axis */
    });
    domClass.add(card,"card");
    var front = domConstruct.create("div",{
      style:"height:"+cardHeight+"px;width:"+cardWidth+"px;background-image:url('"+image+"');background-position:center center;background-repeat:no-repeat;background-size:100%;",
    });
    /* TODO delete */
    tmpCard = card;
    tmpFront = front;
    domClass.add(front,"front");
    domConstruct.place(front,card);
    var back = domConstruct.create("div",{
      style:"height:"+cardHeight+"px;width:"+cardWidth+"px;background-image:url('"+location.href+"images/back.jpg');background-position:center center;background-repeat:no-repeat;background-size:100%;",
    });
    domClass.add(back,"back behind");
    domConstruct.place(back,card);
    return card;
  }
  // for fun, create some cards
  for(var i=0;i<7;i++){
    var rnum = Math.floor((Math.random()*120)+1);
    if(rnum.toString().length == 1) rnum = "00"+rnum;
    if(rnum.toString().length == 2) rnum = "0"+rnum;
    var thisCard = createCard("g0001p0001c000"+(i+1),location.href+"images/A Clash of Arms/"+rnum+".jpg");
    domConstruct.place(thisCard,"gameArea");
    var xVar=(window.innerWidth/7*i+cardWidth/2)-window.innerWidth*.5;
    var yVar=(window.innerHeight-cardHeight-10)-window.innerHeight*.5;
    thisCard.style.left=xVar+"px";
    thisCard.style.top=yVar+"px";
    thisCard.xPercent=xVar/maxX;
    thisCard.yPercent=yVar/maxY;
  }
  dc = domClass; // variable needed to setting timeout on card flip toggle
  dojo.query(".card").forEach(function(node,index,arr){
    var mnode = dojo.dnd.Moveable(node);
    tmpMnode = mnode;
    dojo.connect(node,"onmouseover",function(evt){ /* TODO */ });
    dojo.connect(node,"onmouseout",function(){ /* TODO */ });
    dojo.connect(node,"onclick",function(){ /* TODO onclick event only needs to make the card glow at this point */ });
    dojo.connect(node,"ondblclick",function(){
      front = dojo.query(".front",dojo.byId(node.id))[0];
      back = dojo.query(".back",dojo.byId(node.id))[0];
      if( node.firstElementChild.className.indexOf("behind") == -1 ) {
        domClass.toggle(front,"toback");
        domClass.toggle(back,"tofront");
      } else {
    	domClass.toggle(front,"tofront");
        domClass.toggle(back,"toback");
      }
      window.setTimeout("dc.toggle(front,'behind');dc.toggle(back,'behind');dc.remove(front,'tofront toback');dc.remove(back,'tofront toback');", 1000);
    }); // end ondblclick
    dojo.connect(mnode, "onMoving", function(){ /* TODO */ }); // end onMoving
    dojo.connect(dojo.byId("gameArea"), "onmousemove", function(){ /* TODO */ }); // end onMoving
    dojo.connect(mnode, "onMoveStop", function(){
      console.log(xVar);
      //mnode.node.xPercent = ((mnode.node.style.left.substring(0,mnode.node.style.left.length-2) - mnode.node.style.width.substring(0,mnode.node.style.width.length-2))/2) /maxX;
      //mnode.node.yPercent = ((mnode.node.style.top.substring(0,mnode.node.style.top.length-2) - mnode.node.style.height.substring(0,mnode.node.style.height.length-2))/2) /maxY;
      mnode.node.xPercent = mnode.node.style.left.substring(0,mnode.node.style.left.length-2) /maxX;
      mnode.node.yPercent = mnode.node.style.top.substring(0,mnode.node.style.top.length-2) /maxY;
      //console.log("( "+mnode.node.style.left.substring(0,mnode.node.style.left.length-2)+" / "+maxX+" - "+mnode.node.style.width.substring(0,mnode.node.style.width.length-2)+" ) / 2");
      //console.log(mnode.node.xPercent);
    }); // end onMoveStop
  }); // end query for each card
  window.onresize = function(){
    maxX = window.innerWidth/2;
    maxY = window.innerHeight/2;
    setCardVars();
    setAreaVars();
    dojo.query(".card").forEach(function(node,index,arr){
      node.sizePercent = sizePercent;
      node.style.width = initCardWidth * node.sizePercent + "px";
      node.style.height = initCardHeight * node.sizePercent + "px";
      node.style.left = maxX * node.xPercent+"px";
      node.style.top = maxY * node.yPercent+"px";
    });
    dojo.query(".front,.back").forEach(function(node,index,arr){
      node.style.width = initCardWidth * node.parentNode.sizePercent + "px";
      node.style.height = initCardHeight * node.parentNode.sizePercent + "px";
    });
  }; // end onresize
});
</script>
<script>
function findWindowVars(){
  // called at initial load and every resize to find max X/Y values
  //cardMinHeight = "100";
  //cardMinWidth = "69";	
  //footerMinHeight = cardMinHeight * 1.5;
  maxX = (window.innerWidth/2);
  maxY = (window.innerHeight/2);
}
function setCardVars(){
  /* called at initial load and every resize */
  /* TODO set to size of current regular images (not plot cards) */
  /* TODO try css scaling instead of changeing card width/height */
  initCardWidth = 336;
  initCardHeight = 480;
  /* TODO find out make card size be a percentage of the actual image size */
  //cardHeight = window.innerHeight / 6.5;cardWidth = cardHeight / 1.439628483;
  cardHeight = (window.innerHeight/2) / 3.5;
  cardWidth = cardHeight / 1.449275362;
  sizePercent = cardHeight / initCardHeight;
}
function setAreaVars(){
  /* TODO look into combining with findWindowVars() */
  //footerHeight = window.innerHeight * .15;
  footerHeight = cardHeight * 1.5;
  headerHeight = window.innerHeight * .08;
  playerHeight = (window.innerHeight - headerHeight - footerHeight) / 2;
  //console.log(playerHeight);
  var top = window.innerHeight*.5;
  var left = window.innerWidth*.5;
  //console.log(top+" / "+left);
  document.getElementById("header").style.height = headerHeight+"px";
  document.getElementById("opponentArea").style.height = playerHeight+"px";
  document.getElementById("playerArea").style.height = playerHeight+"px";
  document.getElementById("footer").style.height = footerHeight+"px";
  document.getElementById("footer").style.minHeight = footerMinHeight+"px";
  document.getElementById("footer").style.left = "-"+left+"px";
  document.getElementById("playerArea").style.left = "-"+left+"px";
  document.getElementById("opponentArea").style.left = "-"+left+"px";
  document.getElementById("header").style.left = "-"+left+"px";
  document.getElementById("footer").style.top = (top-document.getElementById("footer").clientHeight)+"px";
  document.getElementById("playerArea").style.top = "0px";
  document.getElementById("opponentArea").style.top = "-"+document.getElementById("opponentArea").clientHeight+"px";
  document.getElementById("header").style.top = "-"+top+"px";
}
</script>
</head>
<body class="tundra game">
<div id="gameArea" class="gameArea">
  <div id="header" class="header">header</div>
  <div id="opponentArea" class="playerArea opponent tmpOpponentArea">opponent</div>
  <div id="playerArea" class="playerArea">player</div>
  <div id="footer" class="footer">footer</div>
</div>
</body>
</html>